# IDA逆向分析ez_rust题目操作指引

## 前言
本指引专为逆向新手编写，将一步步教你如何使用IDA Pro分析ez_rust.exe程序，找出flag验证算法并求解答案。

## 环境要求
- IDA Pro 7.0 或更高版本
- Windows 操作系统
- 基础的C语言和汇编语言知识

## 第一步：在IDA中打开文件

1. 启动IDA Pro
2. 选择 `File` → `Open` 或直接拖拽 `ezrust.exe` 到IDA窗口
3. 在弹出的对话框中：
   - 确认 Processor type 为 `x86-64`
   - 点击 `OK` 开始分析
4. 等待IDA自动分析完成（状态栏显示 `AU: idle`）

## 第二步：定位程序入口点

1. 在IDA View-A窗口中，按 `Ctrl+E` 打开 Entry Points 窗口
2. 你会看到两个入口点：
   - `TlsCallback_0` (0x140012170)
   - `start` (0x14002151c)
3. 双击 `start` 跳转到程序启动点

## 第三步：找到main函数

1. 在start函数中，可以看到类似这样的代码：
   ```assembly
   call    sub_140002040
   ```
2. 双击这个函数调用，进入该函数
3. 在这个函数中找到对main函数的调用：
   ```assembly
   call    sub_1400026F0  ; 这就是main函数
   ```
4. 双击跳转到main函数

## 第四步：分析main函数

1. 在main函数中，你会看到：
   ```c
   int __fastcall main(int argc, const char **argv, const char **envp)
   {
     return sub_140002040(sub_140002220, argc, argv, 0);
   }
   ```
2. 这里 `sub_140002220` 就是核心逻辑函数
3. 双击 `sub_140002220` 进入主要分析函数

## 第五步：分析核心算法函数

### 5.1 观察函数结构
1. 在 `sub_140002220` 函数中，切换到反编译视图：
   - 按 `F5` 或点击菜单 `View` → `Open subviews` → `Generate pseudocode`
2. 观察反编译后的C代码结构

### 5.2 识别关键字符串
1. 在IDA View中按 `Shift+F12` 打开 Strings 窗口
2. 寻找以下关键字符串：
   - `"please input your flag:"`
   - `"Right!\n"`
   - `"Wrong!\n"`
3. 双击这些字符串，查看它们在代码中的引用位置

### 5.3 找到输入处理逻辑
在反编译代码中找到这些关键部分：

1. **长度检查**：
   ```c
   if ( sub_140004D40() != 23 )
     sub_14000C800(0);
   ```
   这表明输入必须是23个字符

2. **字符处理循环**：
   ```c
   while ( 1 )
   {
     n1114112 = sub_140004720(v26);
     if ( n1114112 == 1114112 )
       break;
     LOBYTE(v5) = n1114112;
     sub_140004460(v24, v5);
   }
   ```
   这是读取输入字符的循环

3. **加密算法循环**：
   ```c
   while ( 1 )
   {
     v29 = sub_140003A90(v28);
     if ( !v29 )
       break;
     v12 = v29;
     v13 = sub_140002AE0(v29, 4);
     LOBYTE(v7) = 15;
     v9 = 16 * (sub_140002B30(v12, v7) ^ 8);
     if ( __CFADD__(v9, v13 ^ 9) )
       sub_140022CE0(aAttemptToAddWi, 28, &off_1400245C0);
     LOBYTE(v8) = v9 + (v13 ^ 9);
     sub_140004460(v25, v8);
   }
   ```

## 第六步：分析具体的算法函数

### 6.1 分析 sub_140002AE0 函数
1. 双击 `sub_140002AE0` 进入该函数
2. 按 `F5` 查看反编译代码：
   ```c
   int __fastcall sub_140002AE0(_BYTE *a1, __int64 n4)
   {
     if ( (n4 & 0xFFFFFFF8) != 0 )
       sub_140022CE0("attempt to shift right with overflow", 36, &off_1400246D0);
     return *a1 >> (n4 & 7);
   }
   ```
3. 这个函数实现右移操作：`*a1 >> 4`（提取高4位）

### 6.2 分析 sub_140002B30 函数
1. 双击 `sub_140002B30` 进入该函数
2. 查看反编译代码：
   ```c
   char __fastcall sub_140002B30(_BYTE *a1, char a2)
   {
     return *a1 & a2;
   }
   ```
3. 这个函数实现按位与操作：`*a1 & 15`（提取低4位）

### 6.3 理解加密算法
通过分析得出算法为：
```
对于每个输入字符c：
high_4_bits = c >> 4        // 右移4位获取高4位
low_4_bits = c & 15         // 按位与获取低4位
result = 16 * (low_4_bits ^ 8) + (high_4_bits ^ 9)
```

## 第七步：提取目标数组

### 7.1 找到硬编码数组
在算法分析函数中找到这段代码：
```c
v14 = (_BYTE *)sub_140001000(23, 1);
*v14 = -82;
v14[1] = -36;
v14[2] = -66;
// ... 更多赋值
```

### 7.2 提取完整数组
记录下所有的赋值：
```
[-82, -36, -66, -50, 124, -102, -66, 124, -115, 124, -66, -115, -17, -70, 124, -102, -97, 111, -1, -34, -97, -1, -33]
```

### 7.3 转换为无符号字节
将有符号字节转换为无符号：
- -82 → 174 (0xAE)
- -36 → 220 (0xDC)
- 以此类推...

## 第八步：验证算法理解

### 8.1 手动计算验证
选择一个字符进行手动验证，比如字符 'r' (ASCII 114)：
1. 高4位：114 >> 4 = 7
2. 低4位：114 & 15 = 2  
3. 计算：16 * (2 ^ 8) + (7 ^ 9) = 16 * 10 + 14 = 174

### 8.2 对比目标数组
174 正好等于目标数组的第一个元素，说明算法理解正确！

## 第九步：编写逆向脚本

### 9.1 算法逆向思路
由于算法相对复杂，采用暴力枚举方法：
- 对每个目标字节，尝试所有可能的ASCII字符
- 找到能产生该目标字节的原始字符

### 9.2 Python脚本实现
```python
def solve_ezrust():
    target = [174, 220, 190, 206, 124, 154, 190, 124, 141, 124, 190, 141, 239, 186, 124, 154, 159, 111, 255, 222, 159, 255, 223]
    
    flag = ""
    for target_byte in target:
        for char_val in range(32, 127):  # 可打印ASCII
            high = char_val >> 4
            low = char_val & 15
            if 16 * (low ^ 8) + (high ^ 9) == target_byte:
                flag += chr(char_val)
                break
    return flag
```

## 第十步：验证结果

### 10.1 运行脚本
执行脚本得到：`rUst_1s_@_s@f3_1anguage`

### 10.2 程序验证
用得到的flag测试原程序：
```bash
echo "rUst_1s_@_s@f3_1anguage" | ezrust.exe
```
输出：`Right!` 表示答案正确！

## 常见问题和解决方案

### Q1: IDA反编译结果看不懂怎么办？
**A1:** 
- 多看汇编代码，结合反编译代码理解
- 重命名变量和函数，让代码更易读
- 添加注释记录自己的理解

### Q2: 如何重命名函数和变量？
**A2:** 
- 在函数名上按 `N` 键重命名函数
- 在变量上按 `N` 键重命名变量
- 在地址上按 `;` 键添加注释

### Q3: 找不到关键字符串怎么办？
**A3:** 
- 使用 `Alt+T` 搜索文本
- 检查 Strings 窗口（Shift+F12）
- 查看导入表（Imports 窗口）

### Q4: 算法太复杂看不懂怎么办？
**A4:** 
- 先理解整体流程，再分析细节
- 使用动态调试（如x64dbg）辅助分析
- 采用暴力破解方法绕过复杂算法

## 学习建议

1. **循序渐进**：先从简单的算法题开始练习
2. **多动手**：理论结合实践，多分析不同类型的程序
3. **做笔记**：记录常见的函数模式和分析技巧
4. **交流学习**：加入逆向分析社区，与其他人交流经验

## 总结

通过这个详细的操作指引，你应该能够：
1. 熟练使用IDA Pro的基本功能
2. 理解Rust程序的基本结构
3. 分析位运算算法
4. 编写逆向脚本求解flag

记住，逆向分析需要耐心和练习。每次分析都是学习的机会，不要害怕遇到困难，多尝试、多思考，你一定能够掌握这项技能！

**最终答案：rUst_1s_@_s@f3_1anguage**

---
*本指引适用于IDA Pro 7.x版本，其他版本可能在界面和操作上略有差异。*
