**5G流量总结.md**

``# 从流量包中筛选异常 5G 流量的总结  ## 一、背景 在 5G 系统中，核心网 (Core Network) 通过 **GTP-U (GPRS Tunneling Protocol – User Plane)** 承载用户面数据。   每个 GTP-U 隧道通过 **TEID (Tunnel Endpoint Identifier)** 来区分不同的用户上下文。    一旦攻击者构造出 **非法或异常的 TEID 报文**，可能会导致核心网转发异常，甚至触发系统瘫痪。   因此，在安全分析或 CTF 比赛中，经常需要通过抓到的 `.pcap` 包来定位 **异常 GTP 报文**。  ---  ## 二、分析思路  1. **明确关注协议**      使用 Wireshark / Tshark 过滤 GTP 协议：      ```wireshark    gtp``

2. **统计 TEID 分布**  
    借助 Tshark 导出并统计 TEID 出现次数：
    
    `tshark -r UPF.cap -Y "gtp" -T fields -e gtp.teid | tr ',' '\n' | sort | uniq -c | sort -n`
    
    - 高频 TEID：正常用户面业务流
        
    - 低频/孤立 TEID：可能是伪造或异常
        
    - 同一报文中存在多个 TEID：高度可疑（嵌套、构造攻击）
        
3. **筛选异常特征**  
    常见异常 5G 流量特征包括：
    
    - **TEID = 0**：通常非法（控制面可能出现，用户面不该有）
        
    - **孤立 TEID**：仅出现一次，没有对应的会话建立消息
        
    - **多 TEID 报文**：一个 GTP 报文里出现多个 TEID 字段，属于畸形结构
        
    - **短时快速变换的 TEID**：同一 IP 流短时间内频繁切换 TEID
        
    - **TEID 冲突**：不同用户流量共用同一个 TEID
        
4. **时间顺序还原**  
    将筛选出的异常帧按时间排序；  
    如果题目要求拼接（CTF 常见），就把异常报文中的构造字段（如 TEID）按顺序输出。
    

---

## 三、案例：UPF.cap 异常流量分析

在给定的 `UPF.cap` 样本中，统计结果如下：

      `1 0x011001f7,0x002f7ba5       1 0x011006d9,0x246cfb5b       4 0x3d900be1     397 0x011001f9     672 0xd28006e2     819 0x00b803eb    2109 0x5f30056a`

- 大部分 TEID 出现次数高（正常业务流量）
    
- **仅出现一次且同帧存在两个 TEID** 的报文极为异常：
    
    - 帧 ①：`0x011001f7,0x002f7ba5`
        
    - 帧 ②：`0x011006d9,0x246cfb5b`
        

结合 5G GTP 协议特性，这类“双 TEID 报文”极可能是攻击者伪造的畸形数据。  
按照题目要求，取其中攻击者构造的 TEID（通常为第二个，即 **内层 TEID**），并按时间顺序拼接：

`wdflag{002f7ba5246cfb5b}`

---

## 四、总结

在 5G 流量分析中，异常报文的发现往往基于 **统计 + 协议结构特征**：

- **统计学方法**：通过频次分布找孤立 / 低频 TEID
    
- **结构异常检测**：定位多 TEID、TEID=0、冲突等畸形报文
    
- **上下文关联**：结合 GTP-C 控制面看 TEID 是否有合法分配
    
- **时间序列**：最终确认异常报文顺序，提取所需字段
    

这种方法不仅适用于 CTF 取证题，也适用于实际的 5G 网络安全检测与入侵分析。